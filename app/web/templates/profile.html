{% extends "base.html" %}

{% block title %}æˆ‘çš„ä¸»é¡µ - æ ¡å›­å¤±ç‰©æ‹›é¢†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>ğŸ‘¤ æˆ‘çš„ä¸»é¡µ</h2>
        <p class="text-muted">æ¬¢è¿ï¼Œ{{ current_user.name }} ({{ current_user.student_id }})</p>
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-danger">{{ total_lost }}</h3>
                <p class="mb-0">å‘å¸ƒå¤±ç‰©</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ resolved_lost }}</h3>
                <p class="mb-0">å·²è§£å†³å¤±ç‰©</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ total_found }}</h3>
                <p class="mb-0">å‘å¸ƒæ‹›é¢†</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="text-success">{{ resolved_found }}</h3>
                <p class="mb-0">å·²è§£å†³æ‹›é¢†</p>
            </div>
        </div>
    </div>
</div>

<!-- æ ‡ç­¾é¡µ -->
<ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="lost-tab" data-bs-toggle="tab" data-bs-target="#lost" type="button" role="tab">
            æˆ‘çš„å¤±ç‰© ({{ total_lost }})
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="found-tab" data-bs-toggle="tab" data-bs-target="#found" type="button" role="tab">
            æˆ‘çš„æ‹›é¢† ({{ total_found }})
        </button>
    </li>
</ul>

<div class="tab-content" id="profileTabContent">
    <!-- æˆ‘çš„å¤±ç‰© -->
    <div class="tab-pane fade show active" id="lost" role="tabpanel">
        {% if lost_items %}
            <div class="list-group">
                {% for item in lost_items %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="mb-0 me-2">
                                    <a href="{{ url_for('web.lost_detail', lost_id=item.id) }}" class="text-decoration-none">
                                        {{ item.item_name }}
                                    </a>
                                </h5>
                                {% if item.is_resolved %}
                                    <span class="badge bg-success">å·²è§£å†³</span>
                                {% else %}
                                    <span class="badge bg-warning">æœªè§£å†³</span>
                                {% endif %}
                            </div>
                            <p class="mb-1"><strong>ç±»åˆ«ï¼š</strong>{{ item.category }}</p>
                            <p class="mb-1"><strong>ä¸¢å¤±åœ°ç‚¹ï¼š</strong>{{ item.lost_location }}</p>
                            <p class="mb-1"><strong>ä¸¢å¤±æ—¶é—´ï¼š</strong>{{ item.lost_time.strftime('%Y-%m-%d %H:%M') }}</p>
                            {% if item.description %}
                            <p class="mb-1"><small class="text-muted">{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</small></p>
                            {% endif %}
                        </div>
                        <div class="ms-3">
                            <a href="{{ url_for('web.lost_detail', lost_id=item.id) }}" class="btn btn-sm btn-outline-primary mb-2">æŸ¥çœ‹è¯¦æƒ…</a>
                            {% if not item.is_resolved %}
                            <a href="{{ url_for('web.matches', lost_id=item.id) }}" class="btn btn-sm btn-primary mb-2 d-block">æŸ¥çœ‹åŒ¹é…</a>
                            <button class="btn btn-sm btn-success w-100 mark-resolved-btn" 
                                    data-item-id="{{ item.id }}" 
                                    data-item-type="lost">
                                âœ… æ ‡è®°å·²è§£å†³
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-warning w-100 mark-unresolved-btn" 
                                    data-item-id="{{ item.id }}" 
                                    data-item-type="lost">
                                ğŸ”„ æ ‡è®°æœªè§£å†³
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <p class="mb-0">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒè¿‡å¤±ç‰©ä¿¡æ¯</p>
                <a href="{{ url_for('web.post_lost') }}" class="btn btn-primary mt-2">å‘å¸ƒå¤±ç‰©</a>
            </div>
        {% endif %}
    </div>

    <!-- æˆ‘çš„æ‹›é¢† -->
    <div class="tab-pane fade" id="found" role="tabpanel">
        {% if found_items %}
            <div class="list-group">
                {% for item in found_items %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <h5 class="mb-0 me-2">
                                    <a href="{{ url_for('web.found_detail', found_id=item.id) }}" class="text-decoration-none">
                                        {{ item.item_name }}
                                    </a>
                                </h5>
                                {% if item.is_resolved %}
                                    <span class="badge bg-success">å·²è§£å†³</span>
                                {% else %}
                                    <span class="badge bg-warning">æœªè§£å†³</span>
                                {% endif %}
                            </div>
                            <p class="mb-1"><strong>ç±»åˆ«ï¼š</strong>{{ item.category }}</p>
                            <p class="mb-1"><strong>æ‹¾è·åœ°ç‚¹ï¼š</strong>{{ item.found_location }}</p>
                            <p class="mb-1"><strong>æ‹¾è·æ—¶é—´ï¼š</strong>{{ item.found_time.strftime('%Y-%m-%d %H:%M') }}</p>
                            {% if item.description %}
                            <p class="mb-1"><small class="text-muted">{{ item.description[:100] }}{% if item.description|length > 100 %}...{% endif %}</small></p>
                            {% endif %}
                        </div>
                        <div class="ms-3">
                            <a href="{{ url_for('web.found_detail', found_id=item.id) }}" class="btn btn-sm btn-outline-success mb-2">æŸ¥çœ‹è¯¦æƒ…</a>
                            {% if not item.is_resolved %}
                            <button class="btn btn-sm btn-success w-100 mark-resolved-btn" 
                                    data-item-id="{{ item.id }}" 
                                    data-item-type="found">
                                âœ… æ ‡è®°å·²è§£å†³
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-warning w-100 mark-unresolved-btn" 
                                    data-item-id="{{ item.id }}" 
                                    data-item-type="found">
                                ğŸ”„ æ ‡è®°æœªè§£å†³
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <p class="mb-0">æ‚¨è¿˜æ²¡æœ‰å‘å¸ƒè¿‡æ‹›é¢†ä¿¡æ¯</p>
                <a href="{{ url_for('web.post_found') }}" class="btn btn-success mt-2">å‘å¸ƒæ‹›é¢†</a>
            </div>
        {% endif %}
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('web.index') }}" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
</div>

<script>
// æ ‡è®°ä¸ºå·²è§£å†³/æœªè§£å†³
document.addEventListener('DOMContentLoaded', function() {
    const markResolvedBtns = document.querySelectorAll('.mark-resolved-btn');
    const markUnresolvedBtns = document.querySelectorAll('.mark-unresolved-btn');
    
    markResolvedBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            const itemType = this.getAttribute('data-item-type');
            const itemName = itemType === 'lost' ? 'å¤±ç‰©' : 'æ‹›é¢†';
            
            if (confirm(`ç¡®å®šè¦å°†æ­¤${itemName}æ ‡è®°ä¸ºå·²è§£å†³å—ï¼Ÿ`)) {
                fetch(`/${itemType}/${itemId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ resolved: true })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('æ“ä½œå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        });
    });
    
    markUnresolvedBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            const itemType = this.getAttribute('data-item-type');
            const itemName = itemType === 'lost' ? 'å¤±ç‰©' : 'æ‹›é¢†';
            
            if (confirm(`ç¡®å®šè¦å°†æ­¤${itemName}æ ‡è®°ä¸ºæœªè§£å†³å—ï¼Ÿ`)) {
                fetch(`/${itemType}/${itemId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ resolved: false })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('æ“ä½œå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        });
    });
});
</script>
{% endblock %}

